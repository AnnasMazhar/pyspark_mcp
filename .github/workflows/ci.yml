name: Simplified CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # Step 1: Install and Test
  install-and-test:
    name: Install & Test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"
        cache: 'pip'

    - name: Create virtual environment
      run: |
        python -m venv .venv
        source .venv/bin/activate
        echo "VIRTUAL_ENV=$VIRTUAL_ENV" >> $GITHUB_ENV
        echo "$VIRTUAL_ENV/bin" >> $GITHUB_PATH

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -e .

    - name: Run basic tests
      run: python test.py --ci

  # Step 2: Generate Diff Report
  diff-report:
    name: Generate Diff Report
    runs-on: ubuntu-latest
    needs: install-and-test
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Generate diff report
      run: |
        echo "## ðŸ“‹ Changes Summary" > diff-report.md
        echo "" >> diff-report.md
        echo "### Files Changed:" >> diff-report.md
        git diff --name-only origin/main...HEAD | while read file; do
          echo "- \`$file\`" >> diff-report.md
        done
        echo "" >> diff-report.md
        echo "### Detailed Diff:" >> diff-report.md
        echo "\`\`\`diff" >> diff-report.md
        git diff origin/main...HEAD >> diff-report.md
        echo "\`\`\`" >> diff-report.md

    - name: Comment PR with diff
      uses: actions/github-script@v7
      if: github.event_name == 'pull_request'
      with:
        script: |
          const fs = require('fs');
          const diffReport = fs.readFileSync('diff-report.md', 'utf8');
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: diffReport
          });

  # Step 3: Manual Merge Gate
  manual-merge-gate:
    name: Ready for Manual Merge
    runs-on: ubuntu-latest
    needs: [install-and-test, diff-report]
    if: always() && needs.install-and-test.result == 'success'
    
    steps:
    - name: Manual merge required
      run: |
        echo "âœ… All automated checks passed!"
        echo "ðŸ“‹ Diff report generated (if PR)"
        echo "ðŸ”„ Ready for manual review and merge"
        echo ""
        echo "Next steps:"
        echo "1. Review the diff report in PR comments"
        echo "2. Manually test any critical changes"
        echo "3. Merge when satisfied with changes"